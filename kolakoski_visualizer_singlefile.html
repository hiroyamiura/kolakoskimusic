<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Kolakoski Spiral ‚Äî Single‚ÄëFile (Sidebar + Toggle)</title>
<style>
  :root{
    --bg:#000; --fg:#e5e7eb;
    --panel:#000a; --line:#1f2937;
    --btn:#111827; --btnb:#374151; --btnh:#1f2937;
    --dot1:#fbbf24; --dot2:#f87171; --sticky:#34d399; --temp:#7dd3fc;
    --ring0:#0a2a6b; --ring1:#0b3d91; --ring2:#0c4da4; --ring3:#115bb6;
    --ring4:#1565c0; --ring5:#1b73d0; --ring6:#1e82df; --ring7:#2191ee;
  }
  html, body { height:100%; margin:0; }
  body { background:var(--bg); color:var(--fg); font-family:sans-serif; display:flex; flex-direction:row; min-height:100vh; }

  /* Sidebar for description */
  .sidebar { width:280px; background:#111827; color:#d1d5db; font-size:.8rem; line-height:1.4; padding:1rem; overflow-y:auto; border-right:1px solid #1f2937; }
  .sidebar h2 { font-size:1rem; margin-top:0; }
  .sidebar ul { padding-left:1.2rem; }

  /* Main area holds toolbars + canvas */
  .main { flex:1; display:flex; flex-direction:column; min-width:0; }

  .toolbar { position:sticky; top:0; background:var(--panel); padding:.5rem; display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; border-bottom:1px solid var(--line); z-index:10; }
  .btn { background:var(--btn); border:1px solid var(--btnb); color:var(--fg); padding:.3rem .6rem; border-radius:.4rem; cursor:pointer; }
  .btn:hover { background:var(--btnh); }
  label { font-size:.85rem; color:#d1d5db; display:flex; align-items:center; gap:.35rem; }
  input[type="number"]{ width:7ch; }
  input[type="range"]{ width:120px; }
  select { background:var(--btn); color:var(--fg); border:1px solid var(--btnb); border-radius:.35rem; padding:.2rem .4rem; }
  #stage { flex:1; position:relative; min-height:0; }
  canvas { position:absolute; inset:0; width:100%; height:100%; background:#000; display:block; cursor:default; }
  #tooltip { position:fixed; display:none; pointer-events:none; background:#111827e8; color:#e5e7eb; border:1px solid #374151; padding:.3rem .5rem; border-radius:.35rem; font-size:.8rem; z-index:20; white-space:nowrap; }

  /* Collapsible sidebar */
  body.has-collapsed .sidebar { width:0; padding:0; border:none; }
  body.has-collapsed .sidebar * { display:none; }
</style>
</head>
<body>
  <!-- Sidebar description -->
  <div class="sidebar">
    <h2>What this visualizer does</h2>
    <p>This page is an <strong>interactive music visualizer and generator</strong> based on the <em>Kolakoski sequence</em>. The Kolakoski sequence is an infinite pattern of 1s and 2s that describes its own run-lengths (e.g. <code>122112122‚Ä¶</code>). In this visualizer, that sequence is used to distribute musical pitches around <strong>concentric rings</strong>:</p>
    <ul>
      <li>Each <strong>ring</strong> corresponds to a register of pitches (low to high).</li>
      <li>The <strong>dots</strong> on a ring mark individual frequencies.</li>
      <li>The <strong>spacing of the dots</strong> around the circle is determined by the Kolakoski sequence: ‚Äú1‚Äù means a short angular step, ‚Äú2‚Äù means a double step. This creates the irregular but self-similar spiral pattern.</li>
    </ul>
    <p>Together, the rings form a ‚ÄúKolakoski spiral‚Äù ‚Äî a circular map of pitches that looks ordered but slightly unpredictable, reflecting the recursive nature of the sequence.</p>
    <ul>
      <li><strong>Explore the spiral</strong>: Zoom, pan, and hover over dots to hear tones. Holding <strong>Shift while hovering</strong> keeps notes sounding until released.</li>
      <li><strong>Audio controls</strong>: Change waveforms (sine, triangle, square, saw), adjust volume, attack, and release. You can stop or suspend audio anytime.</li>
      <li><strong>Notation & export</strong>: Export as CSV, MIDI, or MusicXML. Choose <em>performance mode</em> (exact timings) or <em>notated mode</em> (tuplets and 24‚ÄëTET accidentals).</li>
      <li><strong>Flexible tuning</strong>: Show notes in 12‚Äëtone equal temperament or quarter‚Äëtone (24‚ÄëTET). Ring labels show the pitch range in the selected system.</li>
      <li><strong>Tempo & timing</strong>: Set playback tempo (BPM) and how long it takes to traverse one circle of the spiral.</li>
    </ul>
  </div>

  <!-- Main app area -->
  <div class="main">
    <div class="toolbar">
      <button class="btn" id="toggleSidebar" aria-pressed="false" aria-label="Toggle info panel">‚ò∞ Info</button>
      <button class="btn" id="fit">Fit</button>
      <button class="btn" id="zoomIn">Ôºã</button>
      <button class="btn" id="zoomOut">Ôºç</button>
      <label>N rows <input id="nRows" type="number" value="100" min="10" max="600" step="10"></label>
      <label for="fileInput" class="btn">Load CSV‚Ä¶</label>
      <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none">
      <button class="btn" id="downloadCsv">CSV</button>
      <button class="btn" id="downloadMidi">MIDI (performance)</button>
      <label>MusicXML:
        <select id="xmlMode">
          <option value="perf" selected>Performance</option>
          <option value="notated">Notated 32nd+tuplets</option>
        </select>
      </label>
      <button class="btn" id="downloadMusicXML">MusicXML</button>
      <label>Tempo <input id="bpm" type="number" value="60" min="10" max="300"></label>
      <label>Circle time (s) <input id="circleTime" type="number" value="20" min="1" step="0.1"></label>
      <label style="margin-left:.5rem">Show ring ranges <input id="showRanges" type="checkbox" checked></label>
    </div>

    <div class="toolbar">
      <span>Hover = play ‚Ä¢ Shift+hover = latch ‚Ä¢ Click sticky to release</span>
      <button class="btn" id="audioInit">üîä Init Audio</button>
      <button class="btn" id="testBeep">Test</button>
      <button class="btn" id="stopAll">Stop All</button>
      <button class="btn" id="stopAudio">Stop Audio (suspend)</button>
      <label>Wave<select id="wave"><option value="sine">sine</option><option value="triangle">triangle</option><option value="square">square</option><option value="sawtooth">sawtooth</option></select></label>
      <label>Vol<input id="gain" type="range" min="0" max="1" step="0.01" value="0.5"></label>
      <label>Atk<input id="attack" type="range" min="0" max="0.2" step="0.005" value="0.01"></label>
      <label>Rel<input id="release" type="range" min="0.02" max="2" step="0.01" value="0.25"></label>
      <label>Angle<select id="angleMode">
        <option value="even">Even (per ring)</option>
        <option value="kolakEven">Kolak‚Äëorder (even ŒîŒ∏)</option>
        <option value="kolak" selected>Kolak‚Äëproportional ŒîŒ∏</option>
      </select></label>
      <label>Quant<select id="quantMode">
        <option value="12">12‚ÄëTET</option>
        <option value="24" selected>24‚ÄëTET</option>
      </select></label>
    </div>

    <div id="stage"><canvas id="c"></canvas></div>
  </div>
  <div id="tooltip"></div>

<script>
// Collapsible sidebar toggle
(function(){
  var btn = document.getElementById('toggleSidebar');
  if(btn){
    btn.addEventListener('click', function(){
      var on = document.body.classList.toggle('has-collapsed');
      btn.setAttribute('aria-pressed', on ? 'true' : 'false');
    });
  }
})();

/* ===== Utils & labels ===== */
function log2(x){ return Math.log(x)/Math.log(2); }
function clamp(v,a,b){ return Math.min(b, Math.max(a, v)); }
var PC12 = ["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];
function midiFromFreq(f){ return 69 + 12*log2(f/440); }
function label12_full(f){ var m=Math.round(midiFromFreq(f)); var pc=PC12[((m%12)+12)%12]; var oct=Math.floor(m/12)-1; return pc+oct; }
function label12_pc(f){ var m=Math.round(midiFromFreq(f)); return PC12[((m%12)+12)%12]; }
function quantize24Pitch(f){
  var qIdx = Math.round(24*log2(f/440)) + 69*2;
  var pc24 = ((qIdx % 24) + 24) % 24;
  var basePC = Math.floor(pc24/2);
  var half = pc24%2;
  var stepName = PC12[basePC];
  var alter = (stepName.indexOf("#")>=0?1:0) + (half?0.5:0);
  stepName = stepName.replace("#","");
  var midiApprox = Math.round(69 + 12*log2(f/440));
  var octave = Math.floor(midiApprox/12)-1;
  return { step: stepName, alter: alter, octave: octave };
}
function label24_pc_oct(f){
  var q = quantize24Pitch(f);
  var acc = "";
  if (q.alter===0.5) acc="(¬º#)";
  else if (q.alter===-0.5) acc="(¬ºb)";
  else if (q.alter===1.5) acc="(¬æ#)";
  else if (q.alter===-1.5) acc="(¬æb)";
  else if (q.alter===1) acc="#";
  else if (q.alter===-1) acc="b";
  return q.step + acc + q.octave;
}

/* ===== Canvas/view ===== */
var canvas=document.getElementById("c"),ctx=canvas.getContext("2d");
var dpr=1,tx=0,ty=0,scale=1,baseR=140,gap=100;
function initCanvas(){ var r=canvas.getBoundingClientRect(); if(!r.width||!r.height) r={width:window.innerWidth||900,height:(window.innerHeight||650)-160};
  dpr=window.devicePixelRatio||1; canvas.width=r.width*dpr; canvas.height=r.height*dpr; ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
function fit(){ var outer=baseR+5*gap, rect=canvas.getBoundingClientRect(); var maxR=Math.min(rect.width,rect.height)/2-24; scale=Math.max(0.15, maxR/outer); tx=rect.width/2; ty=rect.height/2; }
window.addEventListener("resize",function(){ initCanvas(); fit(); draw(); });
document.getElementById("fit").addEventListener("click",function(){ initCanvas(); fit(); draw(); });
document.getElementById("zoomIn").addEventListener("click",function(){ scale=Math.min(20,scale*1.18); draw(); });
document.getElementById("zoomOut").addEventListener("click",function(){ scale=Math.max(0.2,scale/1.18); draw(); });

/* ===== Data/build ===== */
var allRows=[],nodes=[],hoverDots=[];
var BANDS=[ [41.2,82.41],[82.41,164.81],[164.81,329.63],[329.63,659.26],[659.26,1318.51],[1318.51,1760] ];
function demoRows(){ var arr=[]; var fundamentals=[41.20,82.41,164.81,329.63,659.26,880.00,1318.51];
  for(var i=0;i<fundamentals.length;i++){ var f=fundamentals[i]; for(var p=1;p<=6;p++){ var fr=f*p; if(fr>=41.2 && fr<=1760) arr.push({freq_hz:fr}); } } return arr.slice(0,100); }
function parseCSVSmart(text){
  var lines=text.split(/\r?\n/); if(!lines.length) return [];
  var first=lines.find(function(l){return l.trim().length>0;})||"";
  var delim=','; var counts={',':(first.match(/,/g)||[]).length,'\t':(first.match(/\t/g)||[]).length,';':(first.match(/;/g)||[]).length};
  if(counts['\t']>counts[',']&&counts['\t']>=counts[';'])delim='\t'; else if(counts[';']>counts[',']&&counts[';']>counts['\t'])delim=';';
  function split(line){var out=[],cur="",q=false;for(var i=0;i<line.length;i++){var ch=line[i];if(ch==='"'){if(q&&line[i+1]==='"'){cur+='"';i++;}else q=!q;}else if(ch===delim&&!q){out.push(cur);cur="";}else{cur+=ch;}}out.push(cur);return out;}
  var header=split(lines[0]).map(function(h){return h.trim().toLowerCase();}); var rows=[];
  for(var r=1;r<lines.length;r++){ if(!lines[r].trim()) continue; var cells=split(lines[r]); var obj={}; for(var j=0;j<header.length;j++){ obj[header[j]]=(cells[j]!==undefined?cells[j]:"").trim(); } rows.push(obj); }
  return rows;
}
document.getElementById("fileInput").addEventListener("change", function(e){
  var f=e.target.files[0]; if(!f) return;
  var r=new FileReader();
  r.onload = function(ev){ allRows = parseCSVSmart(ev.target.result); buildNodes(); draw(); };
  r.readAsText(f);
});
document.getElementById("nRows").addEventListener("change", function(){ buildNodes(); draw(); });
document.getElementById("angleMode").addEventListener("change", function(){ buildNodes(); draw(); });
document.getElementById("quantMode").addEventListener("change", function(){ draw(); });

function kolakoski(N){
  var seq=[1,2,2], i=2, val=1;
  while(seq.length<N){
    for(var k=0;k<seq[i] && seq.length<N;k++) seq.push(val);
    val=3-val; i++;
  }
  return seq.slice(0,N);
}
function buildNodes(){
  nodes=[]; hoverDots=[];
  var source = (allRows && allRows.length) ? allRows : demoRows();
  var rows = source.slice(0, +document.getElementById("nRows").value || 100);
  // partition by band
  var perBand = Array(BANDS.length); for(var i=0;i<perBand.length;i++) perBand[i]=[];
  for (var r=0;r<rows.length;r++){
    var f = parseFloat(rows[r].freq_hz); if(!isFinite(f) || f<41.2 || f>1760) continue;
    var bi=0; for(var b=0;b<BANDS.length;b++){ var lo=BANDS[b][0], hi=BANDS[b][1]; var ok=(b<BANDS.length-1)?(f>=lo && f<hi):(f>=lo && f<=hi); if(ok){ bi=b; break; } }
    perBand[bi].push(f);
  }
  var angleMode = document.getElementById("angleMode").value || "kolak";
  for(var b=0;b<perBand.length;b++){
    var list = perBand[b]; var R = baseR + b*gap;
    if(!list.length) continue;
    var N = list.length;
    if (angleMode === "even"){
      var dth = 2*Math.PI/N;
      for (var j=0;j<N;j++){ var a=j*dth; nodes.push({freq:list[j], band:b, a:a, arc:dth, R:R, x:R*Math.cos(a), y:R*Math.sin(a)}); }
    } else if (angleMode === "kolakEven"){
      var dth2 = 2*Math.PI/N;
      var order = kolakoski(N).map(function(_,i){return i;});
      for (var j2=0;j2<N;j2++){ var a2=j2*dth2; nodes.push({freq:list[order[j2]], band:b, a:a2, arc:dth2, R:R, x:R*Math.cos(a2), y:R*Math.sin(a2)}); }
    } else {
      var seq = kolakoski(N);
      var totalUnits = 0; for (var s=0;s<seq.length;s++) totalUnits += (seq[s]===1?1:2);
      var unit = 2*Math.PI / totalUnits;
      var a=0;
      for (var j3=0;j3<N;j3++){
        var step = (seq[j3]===1?1:2)*unit;
        nodes.push({freq:list[j3], band:b, a:(a%(2*Math.PI)), arc:step, R:R, x:R*Math.cos(a), y:R*Math.sin(a)});
        a += step;
      }
    }
  }
}

/* ===== Draw ===== */
function draw(){
  ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); ctx.clearRect(0,0,canvas.width/dpr,canvas.height/dpr);
  ctx.translate(tx,ty); ctx.scale(scale,scale);
  var showRanges = document.getElementById("showRanges").checked;
  var use24 = (document.getElementById("quantMode").value==="24");
  // colored rings & labels
  var cols=["#0a2a6b","#0b3d91","#0c4da4","#115bb6","#1565c0","#1b73d0","#1e82df"];
  for(var i=0;i<6;i++){
    var R = baseR+i*gap;
    ctx.strokeStyle=cols[i%cols.length]; ctx.lineWidth=1.5/Math.max(1,scale);
    ctx.beginPath(); ctx.arc(0,0,R,0,2*Math.PI); ctx.stroke();
    if (showRanges){
      var inBand = []; for(var n=0;n<nodes.length;n++){ if(nodes[n].band===i) inBand.push(nodes[n].freq); }
      if(inBand.length){
        var lo = Math.min.apply(null, inBand), hi = Math.max.apply(null, inBand);
        var label = (use24? label24_pc_oct(lo) : label12_full(lo)) + " ‚Äì " + (use24? label24_pc_oct(hi) : label12_full(hi));
        ctx.save();
        ctx.fillStyle = cols[i%cols.length];
        ctx.textAlign="center"; ctx.textBaseline="bottom";
        ctx.font = (22/Math.max(1,scale)).toFixed(2) + "px sans-serif";
        ctx.fillText(label, 0, -R - 10/Math.max(1,scale));
        ctx.restore();
      }
    }
  }
  // dots
  hoverDots=[];
  var seq = kolakoski(nodes.length);
  for(var i2=0;i2<nodes.length;i2++){
    var nd = nodes[i2];
    var col = (seq[i2]===1 ? "#fbbf24" : "#f87171");
    if (voices[i2]) col = voices[i2].sticky? "#34d399" : "#7dd3fc";
    ctx.fillStyle = col;
    ctx.beginPath(); ctx.arc(nd.x, nd.y, 5/Math.max(1,scale), 0, 2*Math.PI); ctx.fill();
    hoverDots.push({i:i2, x:nd.x, y:nd.y});
  }
}

/* ===== Hit test & tooltip ===== */
function screenToWorld(mx,my){ var r=canvas.getBoundingClientRect(); var lx=mx-r.left, ly=my-r.top; return {x:(lx-tx)/scale, y:(ly-ty)/scale}; }
function hitDot(mx,my){ var p=screenToWorld(mx,my); var best=-1, bd=1e9;
  for(var d=0; d<hoverDots.length; d++){ var hd=hoverDots[d]; var dx=p.x-hd.x, dy=p.y-hd.y; var dd=dx*dx+dy*dy; if(dd<bd){ bd=dd; best=hd.i; } }
  if(best>=0 && bd < (49/(scale*scale))) return best; return -1;
}
var tooltip=document.getElementById("tooltip");
function labelForTooltip(f){ return (document.getElementById("quantMode").value==="24")? label24_pc_oct(f) : label12_pc(f); }
canvas.addEventListener("mousemove", function(e){
  ensureAudio();
  var idx = hitDot(e.clientX, e.clientY);
  if(idx>=0){
    var f = nodes[idx].freq;
    tooltip.textContent = labelForTooltip(f) + " ‚Äî " + f.toFixed(2) + " Hz";
    tooltip.style.left = (e.clientX+12)+"px"; tooltip.style.top = (e.clientY+12)+"px"; tooltip.style.display="block";
    if(!voices[idx]){
      if(!e.shiftKey){ for(var k in voices){ if(!voices[k].sticky) stopVoice(parseInt(k,10), true); } }
      startVoice(idx, !!e.shiftKey); draw();
    }
    canvas.style.cursor="pointer";
  } else {
    tooltip.style.display="none"; canvas.style.cursor="default";
  }
});
canvas.addEventListener("click", function(e){
  var idx = hitDot(e.clientX, e.clientY);
  if(idx>=0 && voices[idx]){ stopVoice(idx, true); draw(); }
});

/* ===== WebAudio ===== */
var voices={}, _ac=null, _master=null;
function ensureAudio(){
  if(!_ac){
    try{
      _ac = new (window.AudioContext||window.webkitAudioContext)();
      _master = _ac.createGain();
      _master.gain.value = parseFloat(document.getElementById("gain").value);
      _master.connect(_ac.destination);
    }catch(e){}
  } else if (_ac.state==="suspended"){ _ac.resume(); }
}
document.getElementById("audioInit").addEventListener("click", function(){ ensureAudio(); });
document.getElementById("gain").addEventListener("input", function(){ if(_master) _master.gain.value=parseFloat(document.getElementById("gain").value); });
document.getElementById("testBeep").addEventListener("click", function(){
  ensureAudio(); if(!_ac) return;
  var now=_ac.currentTime, osc=_ac.createOscillator(), g=_ac.createGain();
  osc.type=document.getElementById("wave").value; osc.frequency.value=440; g.gain.value=0.0001;
  osc.connect(g).connect(_master); osc.start(now);
  g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(1.0, now+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now+0.35); osc.stop(now+0.4);
});
function startVoice(i, sticky){
  ensureAudio(); if(!_ac) return;
  if(voices[i]){ if(sticky) voices[i].sticky=true; return; }
  var nd=nodes[i]; if(!nd) return;
  var osc=_ac.createOscillator(), g=_ac.createGain();
  osc.type=document.getElementById("wave").value; osc.frequency.value=nd.freq; g.gain.value=0.0001;
  osc.connect(g).connect(_master); var now=_ac.currentTime, a=parseFloat(document.getElementById("attack").value)||0.01;
  g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(1.0, now+a);
  osc.start(now);
  voices[i]={osc:osc,g:g,sticky:!!sticky};
}
function stopVoice(i, immediate){
  var v=voices[i]; if(!v) return; var now=_ac.currentTime;
  if(immediate){ try{ v.osc.stop(now); }catch(_){ } }
  else { v.gain.gain.setTargetAtTime(0.0001, now, 0.08); try{ v.osc.stop(now+0.25); }catch(_){ } }
  delete voices[i];
}
document.getElementById("stopAll").addEventListener("click", function(){ for(var k in voices) stopVoice(parseInt(k,10), true); draw(); });
document.getElementById("stopAudio").addEventListener("click", function(){
  for(var k in voices) stopVoice(parseInt(k,10), true);
  if(_ac && _ac.state==="running"){ _ac.suspend(); }
});

/* ===== Exports ===== */
function vlq(n){ var b=[]; do{ b.unshift(n&0x7F); n>>=7; } while(n>0); for(var i=0;i<b.length-1;i++) b[i]|=0x80; return b; }
function freqToMidi(f){ return clamp(Math.round(69 + 12*log2(f/440)),0,127); }
document.getElementById("downloadMidi").addEventListener("click", function(){
  if(!nodes.length) return;
  var circleTime = +document.getElementById("circleTime").value;
  var bpm = +document.getElementById("bpm").value || 60;
  var usPerQuarter = Math.round(60000000 / bpm);
  var TPQ = 480;
  var bytes=[]; function push(){ for(var i=0;i<arguments.length;i++) bytes.push(arguments[i]); }
  push(0x00, 0xFF, 0x51, 0x03, (usPerQuarter>>16)&255, (usPerQuarter>>8)&255, usPerQuarter&255);
  push(0x00, 0xC0, 0x00);
  for (var i=0;i<nodes.length;i++){
    var nd = nodes[i];
    var m=freqToMidi(nd.freq);
    var durSec = (nd.arc? (nd.arc/(2*Math.PI))*circleTime : (1/nodes.length)*circleTime);
    var durTicks = Math.max(1, Math.round(durSec * TPQ * bpm / 60));
    bytes.push.apply(bytes, vlq(0)); push(0x90, m, 96);
    bytes.push.apply(bytes, vlq(durTicks)); push(0x80, m, 0);
  }
  push(0x00, 0xFF, 0x2F, 0x00);
  var header = new Uint8Array([0x4D,0x54,0x68,0x64, 0x00,0x00,0x00,0x06, 0x00,0x00, 0x00,0x01, (TPQ>>8)&255, TPQ&255]);
  var len = bytes.length;
  var lenBytes = new Uint8Array([ (len>>>24)&255, (len>>>16)&255, (len>>>8)&255, len&255 ]);
  var mtrkHead = new Uint8Array([0x4D,0x54,0x72,0x6B]);
  var blob = new Blob([header, mtrkHead, lenBytes, new Uint8Array(bytes)], {type:"audio/midi"});
  var a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="kolakoski_angular.mid"; a.click();
});

document.getElementById("downloadCsv").addEventListener("click", function(){
  if(!nodes.length) return;
  var circleTime = +document.getElementById("circleTime").value;
  var out = "index,band,freq_hz,angle_rad,arc_rad,duration_sec\n";
  for (var i=0;i<nodes.length;i++){
    var nd = nodes[i];
    var dur = (nd.arc? (nd.arc/(2*Math.PI))*circleTime : (1/nodes.length)*circleTime);
    out += (i+1)+","+(nd.band)+","+nd.freq+","+( (nd.a||0) )+","+(nd.arc||0)+","+dur+"\n";
  }
  var blob = new Blob([out], {type:"text/csv"});
  var a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "mapping_with_durations.csv"; a.click();
});

function pitchXML_24TET(f){
  var q = quantize24Pitch(f);
  var step=q.step, alter=q.alter||0, octave=q.octave;
  var accidental = null;
  if (alter===0.5) accidental="quarter-sharp";
  else if (alter===-0.5) accidental="quarter-flat";
  else if (alter===1.5) accidental="three-quarters-sharp";
  else if (alter===-1.5) accidental="three-quarters-flat";
  else if (alter===1) accidental="sharp";
  else if (alter===-1) accidental="flat";
  var p = '<pitch><step>'+step+'</step>'+ (alter?('<alter>'+alter+'</alter>'):'') +'<octave>'+octave+'</octave></pitch>';
  if (accidental) p += '<accidental>'+accidental+'</accidental>';
  return p;
}
function buildDurationsQuarters(){
  var circleTime = +document.getElementById("circleTime").value;
  var bpm = +document.getElementById("bpm").value || 60;
  var out=[];
  for (var i=0;i<nodes.length;i++){
    var nd = nodes[i];
    var durSec = (nd.arc? (nd.arc/(2*Math.PI))*circleTime : (1/nodes.length)*circleTime);
    var q = durSec * bpm / 60.0;
    out.push(q);
  }
  return out;
}
function quantizeNotated(dursQ){
  var allowed = [];
  for (var k=1;k<=32;k++) allowed.push(k/32);
  [3,5,6,7].forEach(function(n){ for (var m=1;m<=8;m++) allowed.push(m/n); });
  allowed = Array.from(new Set(allowed)).filter(function(x){return x>0;}).sort(function(a,b){return a-b;});
  return dursQ.map(function(q){
    var best=allowed[0], bd=Math.abs(q-best);
    for (var i=1;i<allowed.length;i++){ var d=Math.abs(q-allowed[i]); if (d<bd){ bd=d; best=allowed[i]; } }
    return best;
  });
}
function chooseTypeFromQuarter(q){
  if (q>=1.5) return "half";
  if (q>=0.75) return "quarter";
  if (q>=0.375) return "eighth";
  if (q>=0.1875) return "16th";
  return "32nd";
}
document.getElementById("downloadMusicXML").addEventListener("click", function(){
  if(!nodes.length) return;
  var mode = (document.getElementById("xmlMode").value || "perf");
  var dursQ = buildDurationsQuarters();
  var divisions = 960;
  var bpm = +document.getElementById("bpm").value || 60;
  if (mode === "notated") dursQ = quantizeNotated(dursQ);
  var xml = '<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n'
  + '<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">\n'
  + '<score-partwise version="3.1">\n'
  + '  <part-list><score-part id="P1"><part-name>Kolakoski</part-name></score-part></part-list>\n'
  + '  <part id="P1">\n'
  + '    <measure number="1">\n'
  + '      <attributes>\n'
  + '        <divisions>'+divisions+'</divisions>\n'
  + '        <time><beats>4</beats><beat-type>4</beat-type></time>\n'
  + '        <clef><sign>G</sign><line>2</line></clef>\n'
  + '      </attributes>\n'
  + '      <sound tempo="'+bpm+'"/>\n';
  var curBeatsQ = 0;
  for (var i=0;i<nodes.length;i++){
    var f = nodes[i].freq;
    var q = dursQ[i];
    var dur = Math.max(1, Math.round(q*divisions));
    var type = chooseTypeFromQuarter(q);
    if (curBeatsQ + q > 4){
      xml += '      <barline location="right"><bar-style>light-heavy</bar-style></barline>\n    </measure>\n    <measure number="'+(i+1)+'">\n';
      curBeatsQ = 0;
    }
    xml += '      <note>\n        ' + pitchXML_24TET(f) + '\n        <duration>'+dur+'</duration>\n        <type>'+type+'</type>\n      </note>\n';
    curBeatsQ += q;
  }
  xml += '      <barline location="right"><bar-style>light-heavy</bar-style></barline>\n    </measure>\n  </part>\n</score-partwise>';
  var blob = new Blob([xml], {type:"application/vnd.recordare.musicxml+xml"});
  var a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download = (mode==="notated"?"kolakoski_notated.xml":"kolakoski_performance.xml"); a.click();
});

/* ===== Boot (robust) ===== */
function bootOnce(){
  initCanvas(); fit(); buildNodes(); draw();
  if (!nodes.length){
    setTimeout(function(){ initCanvas(); fit(); buildNodes(); draw(); }, 50);
  }
}
if (document.readyState === "complete" || document.readyState === "interactive"){
  requestAnimationFrame(function(){ requestAnimationFrame(bootOnce); });
} else {
  document.addEventListener("DOMContentLoaded", function(){ requestAnimationFrame(function(){ requestAnimationFrame(bootOnce); }); });
}
try{
  var ro = new ResizeObserver(function(entries){
    for (var i=0;i<entries.length;i++){
      var e = entries[i];
      if (e.target === canvas){
        initCanvas(); fit(); draw();
      }
    }
  });
  ro.observe(canvas);
}catch(_){}
</script>
</body>
</html>
